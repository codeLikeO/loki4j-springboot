<?xml version="1.0" encoding="UTF-8"?>
<configuration>


  <conversionRule conversionWord="clr" converterClass="org.springframework.boot.logging.logback.ColorConverter"/>
  <conversionRule conversionWord="wex"
                  converterClass="org.springframework.boot.logging.logback.WhitespaceThrowableProxyConverter"/>
  <conversionRule conversionWord="wEx"
                  converterClass="org.springframework.boot.logging.logback.ExtendedWhitespaceThrowableProxyConverter"/>


  <property name="log.path" value="/var/log/loki4j-springboot"/>

  <property name="log.pattern"
            value="%d{yyyy-MM-dd HH:mm:ss.SSS} -%5p ${PID:- } --- [%t] %X{Request-ID} %-40.40logger{39} Line - [%L] : %m%n"/>





  <appender name="console" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(-%5p) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%X{Request-ID}){yellow} %clr(%-40.40logger{39}){cyan} Line - %clr([%L]){magenta} %clr(:){faint} %m%n
      </pattern>
    </encoder>
  </appender>
  <appender name="LOKI" class="com.github.loki4j.logback.Loki4jAppender">
    <batchMaxItems>100</batchMaxItems>
    <batchTimeoutMs>10000</batchTimeoutMs>
    <http class="com.github.loki4j.logback.ApacheHttpSender">
      <url>http://localhost:3100/loki/api/v1/push</url>
    </http>
    <format>

      <message class="com.github.loki4j.logback.JsonLayout">


      </message>

      <sortByTime>true</sortByTime>
    </format>
  </appender>

 
  <appender name="ASYNC_LOKI" class="ch.qos.logback.classic.AsyncAppender">
    <queueSize>512</queueSize>
    <discardingThreshold>0</discardingThreshold>
    <neverBlock>true</neverBlock>
    <appender-ref ref="LOKI" />
  </appender>





  <appender name="file_info" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>${log.path}/info/info.log</file>
  
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <fileNamePattern>${log.path}/info/info-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
      <maxHistory>30</maxHistory>
      <maxFileSize>100MB</maxFileSize>
    </rollingPolicy>
    <encoder>
      <pattern>${log.pattern}</pattern>
      <charset>UTF-8</charset>
    </encoder>

  </appender>

  <appender name="file_error" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>${log.path}/error/error.log</file>

    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <fileNamePattern>${log.path}/error/error-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
      <maxHistory>30</maxHistory>
      <maxFileSize>50MB</maxFileSize>
    </rollingPolicy>
    <encoder>
      <pattern>${log.pattern}</pattern>
      <charset>UTF-8</charset>
    </encoder>
    <filter class="ch.qos.logback.classic.filter.LevelFilter">
      <level>ERROR</level>
      <onMatch>ACCEPT</onMatch>
      <onMismatch>DENY</onMismatch>
    </filter>
  </appender>



  <appender name="ASYNC-INFO" class="ch.qos.logback.classic.AsyncAppender">
    <discardingThreshold>0</discardingThreshold>
    <queueSize>256</queueSize>
    <appender-ref ref="file_info"/>
  </appender>

  <appender name="ASYNC-ERROR" class="ch.qos.logback.classic.AsyncAppender">
    <discardingThreshold>0</discardingThreshold>
    <queueSize>256</queueSize>
    <appender-ref ref="file_error"/>
  </appender>



  <root level="info">
    <appender-ref ref="console"/>
    <appender-ref ref="ASYNC-INFO"/>
    <appender-ref ref="ASYNC-ERROR"/>
    <appender-ref ref="ASYNC_LOKI" />
  </root>


</configuration>
